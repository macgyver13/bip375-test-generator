description: "Valid PSBT with multiple outputs to same scan key"

test_cases:
  - description: "can finalize: three sp outputs (same scan key) - each output has distinct k value"
    validation_result: "valid"
    inputs:
      - type: "p2wpkh"
        amount: 400000
        key_derivation_suffix: "multi_same_key"
    outputs:
      - type: "silent_payment"
        amount: 100000
        scan_key_id: "default"
        # k=0 (first output)
      - type: "silent_payment"
        amount: 100000
        scan_key_id: "default"
        # k=1 (second output)
      - type: "silent_payment"
        amount: 100000
        scan_key_id: "default"
        # k=2 (third output)
      - type: "regular_p2tr"
        amount: 90000  # Change
    scan_keys:
      - key_id: "default"

  - description: "can finalize: three sp outputs (same scan key) / two regular outputs - k value must not follow output index"
    validation_result: "valid"
    # SP outputs are at output indices 0, 2, 4; regular outputs at 1, 3.
    # With correct per-scan-key k counter: k=0, k=1, k=2.
    # Using output index as k would give k=0, k=2, k=4 â€” wrong scripts for outputs 2 and 4.
    inputs:
      - type: "p2wpkh"
        amount: 500000
        key_derivation_suffix: "interleaved_same_key"
    outputs:
      - type: "silent_payment"
        amount: 100000
        scan_key_id: "default"
        # output index 0, k=0
      - type: "regular_p2tr"
        amount: 50000
      - type: "silent_payment"
        amount: 100000
        scan_key_id: "default"
        # output index 2, k=1 (counter), NOT k=2 (index)
      - type: "regular_p2tr"
        amount: 50000
      - type: "silent_payment"
        amount: 100000
        scan_key_id: "default"
        # output index 4, k=2 (counter), NOT k=4 (index)
      - type: "regular_p2tr"
        amount: 77000  # Change
    scan_keys:
      - key_id: "default"
